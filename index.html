<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Guliguli éª°å­é€£ç·šç‰ˆ</title>
    <style>
        :root { --primary: #ff4757; --bg: #0d0d0d; --card: #1a1a1a; --gold: #f1c40f; --highlight: #ff2e2e; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: #fff; margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 450px; }
        .ui-card { background: var(--card); padding: 20px; border-radius: 20px; text-align: center; margin-bottom: 15px; border: 1px solid #333; }
        
        /* éª°å­ç¹ªè£½ */
        .dice-container { display: flex; justify-content: center; gap: 10px; margin: 15px 0; }
        .dice { width: 60px; height: 60px; background: #fff; border-radius: 10px; display: grid; grid-template: repeat(3, 1fr) / repeat(3, 1fr); padding: 6px; box-sizing: border-box; }
        .dot { width: 10px; height: 10px; background: #333; border-radius: 50%; visibility: hidden; align-self: center; justify-self: center; }
        .dice[data-v="1"] .dot:nth-child(5) { visibility: visible; background: #ff4757; }
        .dice[data-v="2"] .dot:nth-child(1), .dice[data-v="2"] .dot:nth-child(9) { visibility: visible; }
        .dice[data-v="3"] .dot:nth-child(1), .dice[data-v="3"] .dot:nth-child(5), .dice[data-v="3"] .dot:nth-child(9) { visibility: visible; }
        .dice[data-v="4"] .dot:nth-child(1), .dice[data-v="4"] .dot:nth-child(3), .dice[data-v="4"] .dot:nth-child(7), .dice[data-v="4"] .dot:nth-child(9) { visibility: visible; }
        .dice[data-v="5"] .dot:nth-child(1), .dice[data-v="5"] .dot:nth-child(3), .dice[data-v="5"] .dot:nth-child(5), .dice[data-v="5"] .dot:nth-child(7), .dice[data-v="5"] .dot:nth-child(9) { visibility: visible; }
        .dice[data-v="6"] .dot:nth-child(1), .dice[data-v="6"] .dot:nth-child(3), .dice[data-v="6"] .dot:nth-child(4), .dice[data-v="6"] .dot:nth-child(6), .dice[data-v="6"] .dot:nth-child(7), .dice[data-v="6"] .dot:nth-child(9) { visibility: visible; }

        input, select { background: #2d2d2d; color: white; border: 1px solid #444; padding: 12px; width: 100%; border-radius: 10px; margin-bottom: 10px; font-size: 16px; box-sizing: border-box; }
        button { background: var(--primary); color: white; border: none; padding: 15px; border-radius: 10px; cursor: pointer; font-weight: bold; width: 100%; font-size: 18px; }
        button:disabled { opacity: 0.5; }

        #scoreResult { font-size: 24px; font-weight: bold; color: var(--gold); margin: 10px 0; height: 30px; }
        
        /* æ’è¡Œæ¦œå„ªåŒ– */
        .rank-board { background: var(--card); border-radius: 20px; padding: 15px; width: 100%; box-sizing: border-box; border: 1px solid #333; }
        .rank-title { color: var(--gold); font-weight: bold; margin-bottom: 10px; text-align: center; }
        .rank-item { padding: 10px 0; border-bottom: 1px solid #2a2a2a; font-size: 14px; line-height: 1.6; }
        .player-info { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .score-details { font-size: 12px; color: #888; letter-spacing: 1px; }
        .hl { color: var(--highlight) !important; font-weight: bold; }

        .admin-box { display: none; background: #1b3022; padding: 15px; border-radius: 12px; margin-top: 15px; border: 1px solid #2ecc71; }
        .rolling { animation: shake 0.1s infinite; }
        @keyframes shake { 0% {transform: rotate(2deg)} 50% {transform: rotate(-2deg)} 100% {transform: rotate(2deg)} }
    </style>
</head>
<body>

<div class="container">
    <div class="ui-card">
        <input type="text" id="userName" placeholder="ğŸ‘¤ è¼¸å…¥å¤§å">
        <div id="chanceInfo" style="font-size: 12px; color: #888; margin-bottom: 10px;">è¼‰å…¥æ•¸æ“šä¸­...</div>
        
        <div class="dice-container">
            <div class="dice" id="d1" data-v="1"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
            <div class="dice" id="d2" data-v="1"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
            <div class="dice" id="d3" data-v="1"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
        </div>

        <div id="scoreResult"></div>
        <button id="rollBtn" onclick="handleRoll()">ç«‹å³æ“²éª°</button>

        <div id="adminPanel" class="admin-box">
            <p style="margin:0 0 10px 0; color:#2ecc71; font-size:12px;">ğŸ› ï¸ Guliguli å…¨çƒæ§åˆ¶å°</p>
            <select id="rankMode" onchange="syncModeToServer(this.value)">
                <option value="max">ğŸ† æ’åºï¼šå–®æ¬¡æœ€å¤§</option>
                <option value="sum_max">ğŸ”¥ æ’åºï¼šæœ€å¤§ç¸½å’Œ</option>
                <option value="min">ğŸ§Š æ’åºï¼šå–®æ¬¡æœ€å°</option>
                <option value="sum_min">ğŸ’€ æ’åºï¼šæœ€å°ç¸½å’Œ</option>
            </select>
            <button onclick="resetData()" style="background:#c0392b; font-size:12px; padding:8px; margin-top:5px;">æ¸…ç©ºå…¨çƒç´€éŒ„</button>
        </div>
    </div>

    <div class="rank-board">
        <div class="rank-title" id="modeTitle">è¼‰å…¥ä¸­...</div>
        <div id="rankList">é€£ç·šä¸­...</div>
    </div>
</div>

<script>
    const API_URL = "ä½ çš„AppsScriptç¶²å€";
    let rawData = [];
    let currentMode = "max";

    document.getElementById('userName').addEventListener('input', (e) => {
        document.getElementById('adminPanel').style.display = (e.target.value === "Guliguli") ? "block" : "none";
        updateUI();
    });

    async function fetchAll() {
        try {
            const res = await fetch(API_URL);
            const json = await res.json();
            rawData = json.scores;
            currentMode = json.currentMode;
            document.getElementById('rankMode').value = currentMode;
            processAndRender();
            updateUI();
        } catch (e) { console.log("Sync Error"); }
    }

    async function syncModeToServer(mode) {
        currentMode = mode;
        fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'setMode', mode: mode, admin: 'Guliguli' }) });
        processAndRender();
    }

    function updateUI() {
        const name = document.getElementById('userName').value.trim();
        const btn = document.getElementById('rollBtn');
        const count = rawData.filter(r => r[1] === name).length;
        const remains = 3 - count;
        document.getElementById('chanceInfo').innerText = name ? `ç©å®¶ï¼š${name} | å‰©é¤˜ï¼š${remains < 0 ? 0 : remains}æ¬¡` : "è«‹è¼¸å…¥åå­—";
        btn.disabled = !name || remains <= 0;
    }

    function handleRoll() {
        const name = document.getElementById('userName').value.trim();
        const dices = document.querySelectorAll('.dice');
        const btn = document.getElementById('rollBtn');
        btn.disabled = true;
        dices.forEach(d => d.classList.add('rolling'));

        setTimeout(async () => {
            let total = 0;
            dices.forEach(d => {
                d.classList.remove('rolling');
                const v = Math.floor(Math.random() * 6) + 1;
                d.setAttribute('data-v', v);
                total += v;
            });
            document.getElementById('scoreResult').innerText = `${total} é»ï¼`;
            await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'save', name: name, score: total }) });
            setTimeout(fetchAll, 1000);
        }, 800);
    }

    function processAndRender() {
        const listDiv = document.getElementById('rankList');
        const modeMap = { max:"æœ€å¤§å–®æ¬¡", sum_max:"æœ€å¤§ç¸½å’Œ", min:"æœ€å°å–®æ¬¡", sum_min:"æœ€å°ç¸½å’Œ" };
        document.getElementById('modeTitle').innerText = `ğŸ† å…¨çƒæ’è¡Œ (${modeMap[currentMode]})`;

        const players = {};
        rawData.forEach(r => {
            const name = r[1], score = parseInt(r[2]);
            if(!players[name]) players[name] = { name, history: [], sum: 0, max: 0, min: 99 };
            players[name].history.push(score);
            players[name].sum += score;
            players[name].max = Math.max(players[name].max, score);
            players[name].min = Math.min(players[name].min, score);
        });

        const sorted = Object.values(players).sort((a, b) => {
            if(currentMode === 'max') return b.max - a.max;
            if(currentMode === 'sum_max') return b.sum - a.sum;
            if(currentMode === 'min') return a.min - b.min;
            if(currentMode === 'sum_min') return a.sum - b.sum;
        });

        listDiv.innerHTML = sorted.map((p, i) => {
            const h = p.history;
            const isSum = currentMode.includes('sum');
            const targetVal = isSum ? p.sum : (currentMode === 'min' ? p.min : p.max);
            
            // æ¨™ç¤º Highlight
            const h1 = (h[0] && (currentMode==='max' && h[0]===p.max || currentMode==='min' && h[0]===p.min)) ? 'hl' : '';
            const h2 = (h[1] && (currentMode==='max' && h[1]===p.max || currentMode==='min' && h[1]===p.min)) ? 'hl' : '';
            const h3 = (h[2] && (currentMode==='max' && h[2]===p.max || currentMode==='min' && h[2]===p.min)) ? 'hl' : '';
            const sumHl = isSum ? 'hl' : '';

            return `
            <div class="rank-item">
                <div class="player-info">
                    <span>${i+1}. <b>${p.name}</b></span>
                    <span class="${sumHl}">${p.sum} é»</span>
                </div>
                <div class="score-details">
                    ( 1st: <span class="${h1}">${h[0]||'-'}</span>, 
                      2nd: <span class="${h2}">${h[1]||'-'}</span>, 
                      3rd: <span class="${h3}">${h[2]||'-'}</span> )
                </div>
            </div>`;
        }).join('');
    }

    async function resetData() {
        if(!confirm("ç¢ºå®šæ¸…ç©ºå—ï¼Ÿ")) return;
        await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'reset', admin: 'Guliguli' }) });
        location.reload();
    }

    fetchAll();
    setInterval(fetchAll, 15000); // æ¯ 15 ç§’å…¨çƒåŒæ­¥ä¸€æ¬¡
</script>
</body>
</html>
