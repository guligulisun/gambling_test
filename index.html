<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Guliguli Dice Arena</title>
    <style>
        :root { --primary: #ff4757; --bg: #0d0d0d; --card: #1a1a1a; --gold: #f1c40f; --highlight: #ff2e2e; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: #fff; margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        
        .container { width: 100%; max-width: 500px; }
        .ui-card { background: var(--card); padding: 15px; border-radius: 20px; text-align: center; margin-bottom: 15px; border: 1px solid #333; box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        
        /* Dice Graphics */
        .dice-container { display: flex; justify-content: center; gap: 10px; margin: 15px 0; }
        .dice { width: 55px; height: 55px; background: #fff; border-radius: 10px; display: grid; grid-template: repeat(3, 1fr) / repeat(3, 1fr); padding: 5px; box-sizing: border-box; }
        .dot { width: 9px; height: 9px; background: #333; border-radius: 50%; visibility: hidden; align-self: center; justify-self: center; }
        .dice[data-v="1"] .dot:nth-child(5) { visibility: visible; background: var(--primary); }
        .dice[data-v="2"] .dot:nth-child(1), .dice[data-v="2"] .dot:nth-child(9) { visibility: visible; }
        .dice[data-v="3"] .dot:nth-child(1), .dice[data-v="3"] .dot:nth-child(5), .dice[data-v="3"] .dot:nth-child(9) { visibility: visible; }
        .dice[data-v="4"] .dot:nth-child(1), .dice[data-v="4"] .dot:nth-child(3), .dice[data-v="4"] .dot:nth-child(7), .dice[data-v="4"] .dot:nth-child(9) { visibility: visible; }
        .dice[data-v="5"] .dot:nth-child(1), .dice[data-v="5"] .dot:nth-child(3), .dice[data-v="5"] .dot:nth-child(5), .dice[data-v="5"] .dot:nth-child(7), .dice[data-v="5"] .dot:nth-child(9) { visibility: visible; }
        .dice[data-v="6"] .dot:nth-child(1), .dice[data-v="6"] .dot:nth-child(3), .dice[data-v="6"] .dot:nth-child(4), .dice[data-v="6"] .dot:nth-child(6), .dice[data-v="6"] .dot:nth-child(7), .dice[data-v="6"] .dot:nth-child(9) { visibility: visible; }

        input, select { background: #222; color: white; border: 1px solid #444; padding: 12px; width: 100%; border-radius: 10px; margin-bottom: 10px; font-size: 16px; box-sizing: border-box; outline: none; }
        button { background: var(--primary); color: white; border: none; padding: 15px; border-radius: 10px; cursor: pointer; font-weight: bold; width: 100%; font-size: 18px; }
        button:disabled { opacity: 0.3; }

        #scoreResult { font-size: 22px; font-weight: bold; color: var(--gold); margin: 5px 0; height: 30px; }
        
        /* Table Layout */
        .rank-board { background: var(--card); border-radius: 15px; padding: 10px; width: 100%; box-sizing: border-box; border: 1px solid #333; overflow-x: auto; }
        .rank-title { color: var(--gold); font-weight: bold; margin-bottom: 10px; text-align: center; font-size: 16px; }
        
        table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 420px; }
        th { border-bottom: 2px solid #444; padding: 8px 4px; color: #888; text-align: center; }
        td { padding: 10px 4px; border-bottom: 1px solid #222; text-align: center; }
        
        .hl { color: var(--highlight) !important; font-weight: bold; }
        .admin-box { display: none; background: #15251a; padding: 12px; border-radius: 10px; margin-top: 10px; border: 1px solid #2ecc71; font-size: 13px; text-align: left; }
        
        .rolling { animation: shake 0.1s infinite; }
        @keyframes shake { 0% {transform: rotate(2deg)} 50% {transform: rotate(-2deg)} 100% {transform: rotate(2deg)} }
    </style>
</head>
<body>

<div class="container">
    <div class="ui-card">
        <input type="text" id="userName" placeholder="üë§ Enter Player ID">
        <div id="chanceInfo" style="font-size: 12px; color: #666; margin-bottom: 8px;">Connecting...</div>
        
        <div class="dice-container">
            <div id="d1" class="dice" data-v="1"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
            <div id="d2" class="dice" data-v="1"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
            <div id="d3" class="dice" data-v="1"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
        </div>

        <div id="scoreResult"></div>
        <button id="rollBtn" onclick="handleRoll()">Roll Dice</button>

        <div id="adminPanel" class="admin-box">
            <p style="margin:0 0 5px 0; color:#2ecc71;">üîß Guliguli Admin Console</p>
            <select id="rankMode" onchange="syncMode(this.value)">
                <option value="max">üèÜ Sync: Single Max</option>
                <option value="sum_max">üî• Sync: Total Max</option>
                <option value="min">üßä Sync: Single Min</option>
                <option value="sum_min">üíÄ Sync: Total Min</option>
            </select>
            <button onclick="resetData()" style="background:#c0392b; font-size:11px; padding:5px; margin-top:5px; width:100%;">Clear All Data</button>
        </div>
    </div>

    <div class="rank-board">
        <div class="rank-title" id="modeTitle">üèÜ Global Leaderboard</div>
        <table>
            <thead>
                <tr>
                    <th>Rank</th>
                    <th style="text-align:left">Player ID</th>
                    <th>1st</th>
                    <th>2nd</th>
                    <th>3rd</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody id="rankBody">
                </tbody>
        </table>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxKb5ObMpHXa4HZNF_sPe4OFeQVhJC8pDUn4dOp134O5hDydqhKhdHdqD5S0gdO_ss/exec";
    let rawData = [];
    let currentMode = "max";

    document.getElementById('userName').addEventListener('input', (e) => {
        document.getElementById('adminPanel').style.display = (e.target.value === "Guliguli") ? "block" : "none";
        updateUI();
    });

    async function fetchAll() {
        try {
            const res = await fetch(API_URL);
            const json = await res.json();
            rawData = json.scores;
            currentMode = json.currentMode || "max";
            if (document.getElementById('userName').value !== "Guliguli") {
                document.getElementById('rankMode').value = currentMode;
            }
            processAndRender();
            updateUI();
        } catch (e) { console.log("Sync failed"); }
    }

    async function syncMode(m) {
        currentMode = m;
        processAndRender();
        fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'setMode', mode: m, admin: 'Guliguli' }) });
    }

    function updateUI() {
        const name = document.getElementById('userName').value.trim();
        const count = rawData.filter(r => r[1] === name).length;
        document.getElementById('chanceInfo').innerText = name ? `ID: ${name} | Attempts: ${count}/3` : "Enter Player ID";
        document.getElementById('rollBtn').disabled = !name || count >= 3;
    }

    function handleRoll() {
        const name = document.getElementById('userName').value.trim();
        const dices = document.querySelectorAll('.dice');
        const btn = document.getElementById('rollBtn');
        btn.disabled = true;
        dices.forEach(d => d.classList.add('rolling'));

        setTimeout(async () => {
            let total = 0;
            dices.forEach(d => {
                d.classList.remove('rolling');
                const v = Math.floor(Math.random() * 6) + 1;
                d.setAttribute('data-v', v);
                total += v;
            });
            document.getElementById('scoreResult').innerText = `${total} Pts!`;

            // Pessimistic-to-Optimistic UI:
            rawData.push(["NOW", name, total]);
            processAndRender();
            updateUI();

            try {
                await fetch(API_URL, { 
                    method: 'POST', 
                    mode: 'no-cors', 
                    body: JSON.stringify({ action: 'save', name: name, score: total }) 
                });
                setTimeout(fetchAll, 2000);
            } catch(e) { console.log("Post error"); }
        }, 800);
    }

    function processAndRender() {
        const body = document.getElementById('rankBody');
        const modeMap = { max:"Single Max", sum_max:"Total Max", min:"Single Min", sum_min:"Total Min" };
        document.getElementById('modeTitle').innerText = `üèÜ Leaderboard (${modeMap[currentMode]})`;

        const players = {};
        rawData.forEach(r => {
            const name = r[1], score = parseInt(r[2]);
            if(!name) return;
            if(!players[name]) players[name] = { name, history: [], sum: 0, max: 0, min: 99 };
            players[name].history.push(score);
            players[name].sum += score;
            players[name].max = Math.max(players[name].max, score);
            players[name].min = Math.min(players[name].min, score);
        });

        const sorted = Object.values(players).sort((a, b) => {
            if(currentMode === 'max') return b.max - a.max;
            if(currentMode === 'sum_max') return b.sum - a.sum;
            if(currentMode === 'min') return a.min - b.min;
            if(currentMode === 'sum_min') return a.sum - b.sum;
        });

        body.innerHTML = sorted.map((p, i) => {
            const h = p.history;
            const isSum = currentMode.includes('sum');
            const checkHL = (v) => {
                if (isSum || !v) return '';
                return (currentMode==='max' && v===p.max) || (currentMode==='min' && v===p.min) ? 'hl' : '';
            };

            return `
            <tr>
                <td style="color:#666">${i+1}</td>
                <td style="text-align:left; font-weight:bold">${p.name}</td>
                <td class="${checkHL(h[0])}">${h[0]||'-'}</td>
                <td class="${checkHL(h[1])}">${h[1]||'-'}</td>
                <td class="${checkHL(h[2])}">${h[2]||'-'}</td>
                <td class="${isSum?'hl':''}">${p.sum}</td>
            </tr>`;
        }).join('') || `<tr><td colspan="6" style="padding:20px; color:#444">No records found</td></tr>`;
    }

    async function resetData() {
        if(!confirm("Guliguli, are you sure you want to clear all data?")) return;
        fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'reset', admin: 'Guliguli' }) });
        setTimeout(() => location.reload(), 1000);
    }

    fetchAll();
    setInterval(fetchAll, 10000);
</script>
</body>
</html>
