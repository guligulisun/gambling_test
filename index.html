<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Guliguli éª°å­ç«¶æŠ€å ´</title>
    <style>
        :root { --primary: #ff4757; --bg: #0f0f0f; --card: #1e1e1e; --gold: #f1c40f; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: #fff; margin: 0; display: flex; flex-direction: column; align-items: center; padding: 15px; }
        
        .container { width: 100%; max-width: 400px; }
        .ui-card { background: var(--card); padding: 20px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); text-align: center; margin-bottom: 20px; border: 1px solid #333; }

        /* éª°å­ç¹ªè£½ */
        .dice-container { display: flex; justify-content: center; gap: 12px; margin: 20px 0; }
        .dice { width: 65px; height: 65px; background: #fff; border-radius: 12px; display: grid; grid-template: repeat(3, 1fr) / repeat(3, 1fr); padding: 8px; box-sizing: border-box; }
        .dot { width: 12px; height: 12px; background: #333; border-radius: 50%; visibility: hidden; align-self: center; justify-self: center; }
        .dice[data-v="1"] .dot:nth-child(5) { visibility: visible; background: #ff4757; width: 16px; height: 16px; }
        .dice[data-v="2"] .dot:nth-child(1), .dice[data-v="2"] .dot:nth-child(9) { visibility: visible; }
        .dice[data-v="3"] .dot:nth-child(1), .dice[data-v="3"] .dot:nth-child(5), .dice[data-v="3"] .dot:nth-child(9) { visibility: visible; }
        .dice[data-v="4"] .dot:nth-child(1), .dice[data-v="4"] .dot:nth-child(3), .dice[data-v="4"] .dot:nth-child(7), .dice[data-v="4"] .dot:nth-child(9) { visibility: visible; }
        .dice[data-v="5"] .dot:nth-child(1), .dice[data-v="5"] .dot:nth-child(3), .dice[data-v="5"] .dot:nth-child(5), .dice[data-v="5"] .dot:nth-child(7), .dice[data-v="5"] .dot:nth-child(9) { visibility: visible; }
        .dice[data-v="6"] .dot:nth-child(1), .dice[data-v="6"] .dot:nth-child(3), .dice[data-v="6"] .dot:nth-child(4), .dice[data-v="6"] .dot:nth-child(6), .dice[data-v="6"] .dot:nth-child(7), .dice[data-v="6"] .dot:nth-child(9) { visibility: visible; }

        /* è¼¸å…¥èˆ‡æŒ‰éˆ• */
        input, select { background: #2d2d2d; color: white; border: 1px solid #444; padding: 15px; width: 100%; border-radius: 12px; margin-bottom: 12px; box-sizing: border-box; font-size: 16px; outline: none; }
        button { background: var(--primary); color: white; border: none; padding: 16px; border-radius: 12px; cursor: pointer; font-weight: bold; width: 100%; font-size: 18px; transition: 0.2s; }
        button:disabled { background: #444; opacity: 0.6; cursor: not-allowed; }

        #scoreResult { font-size: 26px; font-weight: 800; color: var(--gold); margin: 15px 0; height: 35px; }
        
        /* æ’è¡Œæ¦œæ¨£å¼ */
        .rank-board { background: var(--card); border-radius: 25px; padding: 20px; width: 100%; box-sizing: border-box; border: 1px solid #333; }
        .rank-header { border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 15px; font-weight: bold; color: var(--gold); display: flex; justify-content: space-between; }
        .rank-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #2a2a2a; font-size: 15px; animation: fadeIn 0.5s; }
        
        .admin-panel { display: none; background: #1e3a2a; padding: 15px; border-radius: 15px; margin-top: 20px; border: 1px solid #2ecc71; }
        .rolling { animation: shake 0.1s infinite; }
        @keyframes shake { 0% {transform: rotate(2deg)} 50% {transform: rotate(-2deg)} 100% {transform: rotate(2deg)} }
        @keyframes fadeIn { from {opacity: 0; transform: translateY(5px);} to {opacity: 1; transform: translateY(0);} }
    </style>
</head>
<body>

    <div class="container">
        <div class="ui-card">
            <input type="text" id="userName" placeholder="ğŸ‘¤ è¼¸å…¥å¤§åé–‹å§‹éŠæˆ²">
            <div id="chanceInfo" style="font-size: 13px; color: #888; margin-bottom: 5px;">é€£ç·šä¸­...</div>
            
            <div class="dice-container">
                <div class="dice" id="d1" data-v="1"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                <div class="dice" id="d2" data-v="1"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                <div class="dice" id="d3" data-v="1"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
            </div>

            <div id="scoreResult"></div>
            <button id="rollBtn" onclick="handleRoll()" disabled>è¼‰å…¥ä¸­...</button>

            <div id="adminPanel" class="admin-panel">
                <p style="margin: 0 0 10px 0; font-size: 14px; color: #2ecc71; font-weight: bold;">ğŸ› ï¸ Guliguli æ§åˆ¶å°</p>
                <select id="rankMode" onchange="processAndRender()">
                    <option value="max">ğŸ† æ’åºï¼šå–®æ¬¡æœ€é«˜åˆ†</option>
                    <option value="sum_max">ğŸ”¥ æ’åºï¼šç´¯ç©ç¸½åˆ†æœ€é«˜</option>
                    <option value="min">ğŸ§Š æ’åºï¼šå–®æ¬¡æœ€ä½åˆ†</option>
                    <option value="sum_min">ğŸ’€ æ’åºï¼šç´¯ç©ç¸½åˆ†æœ€ä½</option>
                </select>
                <button onclick="resetServerData()" style="background: #e74c3c; font-size: 14px; padding: 10px;">âš ï¸ æ¸…é™¤ä¼ºæœå™¨æ‰€æœ‰æ•¸æ“š</button>
            </div>
        </div>

        <div class="rank-board">
            <div class="rank-header">
                <span>ğŸŒ å…¨çƒæ’è¡Œæ¦œ</span>
                <span id="syncStatus" style="font-size: 10px; color: #555;">â—</span>
            </div>
            <div id="rankList">è¼‰å…¥æ•¸æ“šä¸­...</div>
        </div>
    </div>

    <script>
        // ä½ çš„ Google Apps Script URL
        const API_URL = "https://script.google.com/macros/s/AKfycbxKb5ObMpHXa4HZNF_sPe4OFeQVhJC8pDUn4dOp134O5hDydqhKhdHdqD5S0gdO_ss/exec";
        let rawData = [];
        const MAX_CHANCES = 3;

        // ç›£è½åå­—è¼¸å…¥è§¸ç™¼ç®¡ç†å“¡æ¨¡å¼
        document.getElementById('userName').addEventListener('input', (e) => {
            const name = e.target.value.trim();
            document.getElementById('adminPanel').style.display = (name === "Guliguli") ? "block" : "none";
            updateUI();
        });

        async function fetchRanks() {
            const status = document.getElementById('syncStatus');
            status.style.color = '#f1c40f'; // åŒæ­¥ä¸­é»ƒç‡ˆ
            try {
                const res = await fetch(API_URL);
                rawData = await res.json();
                processAndRender();
                updateUI();
                status.style.color = '#2ecc71'; // æˆåŠŸç¶ ç‡ˆ
            } catch (e) { 
                console.error("åŒæ­¥å¤±æ•—"); 
                status.style.color = '#e74c3c'; // å¤±æ•—ç´…ç‡ˆ
            }
        }

        function updateUI() {
            const name = document.getElementById('userName').value.trim();
            const btn = document.getElementById('rollBtn');
            const info = document.getElementById('chanceInfo');
            
            if (!name) {
                btn.disabled = true;
                btn.innerText = "è«‹è¼¸å…¥åå­—";
                info.innerText = "è¼¸å…¥åå­—ä»¥æŸ¥çœ‹å‰©é¤˜æ¬¡æ•¸";
                return;
            }

            const userHistory = rawData.filter(r => r[1] === name);
            const count = userHistory.length;
            const remains = MAX_CHANCES - count;
            
            info.innerText = `ç©å®¶ï¼š${name} | å·²æŠ•æ“²ï¼š${count} æ¬¡`;
            btn.innerText = `ç«‹å³æ“²éª° (å‰© ${remains < 0 ? 0 : remains} æ¬¡)`;
            btn.disabled = remains <= 0;
        }

        async function handleRoll() {
            const name = document.getElementById('userName').value.trim();
            const dices = document.querySelectorAll('.dice');
            const resultDiv = document.getElementById('scoreResult');
            const btn = document.getElementById('rollBtn');

            btn.disabled = true;
            dices.forEach(d => d.classList.add('rolling'));
            resultDiv.innerText = "æ­£åœ¨æ±‚ç¥å•åœ...";

            setTimeout(async () => {
                let currentTotal = 0;
                dices.forEach(d => {
                    d.classList.remove('rolling');
                    const val = Math.floor(Math.random() * 6) + 1;
                    d.setAttribute('data-v', val);
                    currentTotal += val;
                });

                resultDiv.innerText = `${currentTotal} é»ï¼`;

                try {
                    // ç™¼é€åˆ° Google Sheets
                    await fetch(API_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        body: JSON.stringify({ action: 'save', name: name, score: currentTotal })
                    });
                    
                    // ç‚ºäº†é«”æ„Ÿæµæš¢ï¼Œå…ˆåœ¨æœ¬åœ°ç«¯å‡å¢åŠ ä¸€ç­†è³‡æ–™
                    rawData.push([new Date().toISOString(), name, currentTotal]);
                    updateUI();
                    processAndRender();
                    
                    // 3ç§’å¾Œæ­£å¼å¾ä¼ºæœå™¨é‡æ–°åŒæ­¥
                    setTimeout(fetchRanks, 3000);
                } catch (e) { 
                    alert("ç¶²è·¯é€£ç·šä¼¼ä¹æœ‰å•é¡Œï¼Œè«‹é‡æ–°æ•´ç†é é¢ã€‚"); 
                }
            }, 800);
        }

        function processAndRender() {
            const mode = document.getElementById('rankMode').value;
            const listDiv = document.getElementById('rankList');
            
            const players = {};
            rawData.forEach(row => {
                const name = row[1];
                const score = parseInt(row[2]);
                if (!name) return;
                
                if (!players[name]) {
                    players[name] = { name, scores: [], sum: 0, max: 0, min: 99 };
                }
                players[name].scores.push(score);
                players[name].sum += score;
                players[name].max = Math.max(players[name].max, score);
                players[name].min = Math.min(players[name].min, score);
            });

            const sorted = Object.values(players).sort((a, b) => {
                if (mode === 'max') return b.max - a.max;
                if (mode === 'sum_max') return b.sum - a.sum;
                if (mode === 'min') return a.min - b.min;
                if (mode === 'sum_min') return a.sum - b.sum;
            });

            listDiv.innerHTML = sorted.map((p, i) => {
                let displayVal = p.max;
                if (mode.includes('sum')) displayVal = p.sum;
                else if (mode === 'min') displayVal = p.min;
                
                let medal = "";
                if (i === 0) medal = "ğŸ¥‡ ";
                else if (i === 1) medal = "ğŸ¥ˆ ";
                else if (i === 2) medal = "ğŸ¥‰ ";

                return `
                <div class="rank-item">
                    <span>${medal}${i + 1}. <b>${p.name}</b> <small style="color:#666">(${p.scores.length})</small></span>
                    <span style="color:var(--gold); font-weight:bold;">${displayVal} é»</span>
                </div>`;
            }).join('') || `<div style="text-align:center; padding:20px; color:#555;">å°šç„¡æŒ‘æˆ°ç´€éŒ„</div>`;
        }

        async function resetServerData() {
            if (!confirm("Guliguli ç®¡ç†å“¡ï¼Œç¢ºå®šè¦æ¸…ç©ºä¼ºæœå™¨ä¸Šçš„æ‰€æœ‰æ­·å²ç´€éŒ„å—ï¼Ÿé€™ç„¡æ³•å¾©åŸå–”ï¼")) return;
            const btn = document.querySelector('.admin-panel button');
            btn.disabled = true;
            btn.innerText = "æ¸…é™¤ä¸­...";
            
            try {
                await fetch(API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({ action: 'reset', admin: 'Guliguli' })
                });
                alert("ä¼ºæœå™¨å·²æ¸…ç©ºï¼");
                location.reload();
            } catch (e) { 
                alert("æ¸…é™¤å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚"); 
                btn.disabled = false;
            }
        }

        // å•Ÿå‹•æµç¨‹
        fetchRanks();
        // æ¯ 30 ç§’éœé»˜æ›´æ–°ä¸€æ¬¡æ’è¡Œæ¦œ
        setInterval(fetchRanks, 30000);
    </script>
</body>
</html>
