<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Guliguli éª°å­é€£ç·šç‰ˆ</title>
    <style>
        :root { --primary: #ff4757; --bg: #0d0d0d; --card: #1a1a1a; --gold: #f1c40f; --highlight: #ff2e2e; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: #fff; margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        
        .container { width: 100%; max-width: 450px; }
        .ui-card { background: var(--card); padding: 20px; border-radius: 20px; text-align: center; margin-bottom: 15px; border: 1px solid #333; box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        
        /* éª°å­ç¹ªè£½ */
        .dice-container { display: flex; justify-content: center; gap: 10px; margin: 15px 0; }
        .dice { width: 60px; height: 60px; background: #fff; border-radius: 10px; display: grid; grid-template: repeat(3, 1fr) / repeat(3, 1fr); padding: 6px; box-sizing: border-box; box-shadow: inset 0 -3px 3px rgba(0,0,0,0.2); }
        .dot { width: 10px; height: 10px; background: #333; border-radius: 50%; visibility: hidden; align-self: center; justify-self: center; }
        .dice[data-v="1"] .dot:nth-child(5) { visibility: visible; background: var(--primary); width: 14px; height: 14px; }
        .dice[data-v="2"] .dot:nth-child(1), .dice[data-v="2"] .dot:nth-child(9) { visibility: visible; }
        .dice[data-v="3"] .dot:nth-child(1), .dice[data-v="3"] .dot:nth-child(5), .dice[data-v="3"] .dot:nth-child(9) { visibility: visible; }
        .dice[data-v="4"] .dot:nth-child(1), .dice[data-v="4"] .dot:nth-child(3), .dice[data-v="4"] .dot:nth-child(7), .dice[data-v="4"] .dot:nth-child(9) { visibility: visible; }
        .dice[data-v="5"] .dot:nth-child(1), .dice[data-v="5"] .dot:nth-child(3), .dice[data-v="5"] .dot:nth-child(5), .dice[data-v="5"] .dot:nth-child(7), .dice[data-v="5"] .dot:nth-child(9) { visibility: visible; }
        .dice[data-v="6"] .dot:nth-child(1), .dice[data-v="6"] .dot:nth-child(3), .dice[data-v="6"] .dot:nth-child(4), .dice[data-v="6"] .dot:nth-child(6), .dice[data-v="6"] .dot:nth-child(7), .dice[data-v="6"] .dot:nth-child(9) { visibility: visible; }

        input, select { background: #2d2d2d; color: white; border: 1px solid #444; padding: 12px; width: 100%; border-radius: 10px; margin-bottom: 10px; font-size: 16px; box-sizing: border-box; outline: none; }
        button { background: var(--primary); color: white; border: none; padding: 15px; border-radius: 10px; cursor: pointer; font-weight: bold; width: 100%; font-size: 18px; transition: 0.2s; }
        button:disabled { opacity: 0.4; cursor: not-allowed; }

        #scoreResult { font-size: 24px; font-weight: 800; color: var(--gold); margin: 10px 0; height: 30px; }
        
        /* æ’è¡Œæ¦œ */
        .rank-board { background: var(--card); border-radius: 20px; padding: 15px; width: 100%; box-sizing: border-box; border: 1px solid #333; }
        .rank-title { color: var(--gold); font-weight: bold; margin-bottom: 15px; text-align: center; border-bottom: 1px solid #333; padding-bottom: 10px; font-size: 18px; }
        .rank-item { padding: 12px 0; border-bottom: 1px solid #2a2a2a; font-size: 14px; line-height: 1.6; animation: fadeIn 0.4s ease-out; }
        .player-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .score-details { font-size: 12px; color: #777; letter-spacing: 0.5px; }
        .hl { color: var(--highlight) !important; font-weight: bold; text-shadow: 0 0 5px rgba(255,46,46,0.3); }

        /* ç®¡ç†é¢æ¿ */
        .admin-box { display: none; background: #1b3022; padding: 15px; border-radius: 12px; margin-top: 15px; border: 1px solid #2ecc71; text-align: left; }
        .admin-box p { margin: 0 0 8px 0; color: #2ecc71; font-weight: bold; font-size: 13px; }
        
        .rolling { animation: shake 0.1s infinite; }
        @keyframes shake { 0% {transform: rotate(2deg)} 50% {transform: rotate(-2deg)} 100% {transform: rotate(2deg)} }
        @keyframes fadeIn { from {opacity: 0; transform: translateY(5px);} to {opacity: 1; transform: translateY(0);} }
    </style>
</head>
<body>

<div class="container">
    <div class="ui-card">
        <input type="text" id="userName" placeholder="ğŸ‘¤ è¼¸å…¥å¤§å">
        <div id="chanceInfo" style="font-size: 12px; color: #888; margin-bottom: 10px;">è«‹è¼¸å…¥åå­—è¼‰å…¥é€²åº¦</div>
        
        <div class="dice-container">
            <div class="dice" id="d1" data-v="1"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
            <div class="dice" id="d2" data-v="1"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
            <div class="dice" id="d3" data-v="1"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
        </div>

        <div id="scoreResult"></div>
        <button id="rollBtn" onclick="handleRoll()">ç«‹å³æ“²éª°</button>

        <div id="adminPanel" class="admin-box">
            <p>ğŸ”§ Guliguli å…¨çƒæ§åˆ¶å°</p>
            <select id="rankMode" onchange="syncModeToServer(this.value)">
                <option value="max">ğŸ† å…¨çƒåŒæ­¥ï¼šå–®æ¬¡æœ€å¤§</option>
                <option value="sum_max">ğŸ”¥ å…¨çƒåŒæ­¥ï¼šæœ€å¤§ç¸½å’Œ</option>
                <option value="min">ğŸ§Š å…¨çƒåŒæ­¥ï¼šå–®æ¬¡æœ€å°</option>
                <option value="sum_min">ğŸ’€ å…¨çƒåŒæ­¥ï¼šæœ€å°ç¸½å’Œ</option>
            </select>
            <button onclick="resetData()" style="background:#c0392b; font-size:12px; padding:8px; margin-top:5px; width:100%;">æ¸…ç©ºå…¨çƒæ•¸æ“š</button>
        </div>
    </div>

    <div class="rank-board">
        <div class="rank-title" id="modeTitle">ğŸ† å…¨çƒæ’è¡Œè¼‰å…¥ä¸­...</div>
        <div id="rankList" style="text-align:center; color:#555;">é€£ç·šåŒæ­¥ä¸­...</div>
    </div>
</div>

<script>
    // ğŸ”— è«‹å°‡æ­¤è™•æ›æˆä½ çš„ Apps Script URL
    const API_URL = "https://script.google.com/macros/s/AKfycbxKb5ObMpHXa4HZNF_sPe4OFeQVhJC8pDUn4dOp134O5hDydqhKhdHdqD5S0gdO_ss/exec";
    
    let rawData = [];
    let currentMode = "max";

    // ç›£è½åå­—è¼¸å…¥
    document.getElementById('userName').addEventListener('input', (e) => {
        const val = e.target.value.trim();
        document.getElementById('adminPanel').style.display = (val === "Guliguli") ? "block" : "none";
        updateUI();
    });

    // æ ¸å¿ƒæ•¸æ“šæŠ“å–
    async function fetchAll() {
        try {
            const res = await fetch(API_URL);
            const json = await res.json();
            rawData = json.scores;
            currentMode = json.currentMode || "max";
            
            // å¦‚æœä¸æ˜¯ç®¡ç†å“¡ï¼Œå‰‡è‡ªå‹•åŒæ­¥ UI ä¸‹æ‹‰é¸å–®é¡¯ç¤º
            if (document.getElementById('userName').value !== "Guliguli") {
                document.getElementById('rankMode').value = currentMode;
            }
            
            processAndRender();
            updateUI();
        } catch (e) { console.log("Fetch Error"); }
    }

    // ç®¡ç†å“¡åˆ‡æ›åŒæ­¥æ¨¡å¼
    async function syncModeToServer(mode) {
        currentMode = mode;
        processAndRender(); // ç«‹å³æ¸²æŸ“æœ¬åœ°ï¼Œå¢åŠ æµæš¢æ„Ÿ
        try {
            await fetch(API_URL, { 
                method: 'POST', 
                mode: 'no-cors', 
                body: JSON.stringify({ action: 'setMode', mode: mode, admin: 'Guliguli' }) 
            });
        } catch (e) { console.log("Sync Mode Error"); }
    }

    function updateUI() {
        const name = document.getElementById('userName').value.trim();
        const btn = document.getElementById('rollBtn');
        const info = document.getElementById('chanceInfo');
        
        if (!name) {
            btn.disabled = true;
            info.innerText = "è¼¸å…¥å¤§åä»¥æŸ¥çœ‹é€²åº¦";
            return;
        }

        const count = rawData.filter(r => r[1] === name).length;
        const remains = 3 - count;
        info.innerText = `ç©å®¶ï¼š${name} | å‰©é¤˜ï¼š${remains < 0 ? 0 : remains}æ¬¡`;
        btn.innerText = remains <= 0 ? "æ¬¡æ•¸å·²ç”¨å®Œ" : "ç«‹å³æ“²éª°";
        btn.disabled = remains <= 0;
    }

    async function handleRoll() {
        const name = document.getElementById('userName').value.trim();
        const dices = document.querySelectorAll('.dice');
        const btn = document.getElementById('rollBtn');
        const resDiv = document.getElementById('scoreResult');

        btn.disabled = true;
        dices.forEach(d => d.classList.add('rolling'));
        resDiv.innerText = "æ­£åœ¨æ±‚ç¥å•åœ...";

        setTimeout(async () => {
            let total = 0;
            dices.forEach(d => {
                d.classList.remove('rolling');
                const v = Math.floor(Math.random() * 6) + 1;
                d.setAttribute('data-v', v);
                total += v;
            });
            resDiv.innerText = `${total} é»ï¼`;

            try {
                // ç™¼é€æ•¸æ“šåˆ° Server
                await fetch(API_URL, { 
                    method: 'POST', 
                    mode: 'no-cors', 
                    body: JSON.stringify({ action: 'save', name: name, score: total }) 
                });
                
                // ğŸš€ æ“ä½œè€…ç«‹å³æ›´æ–° (éå°ç¨±åŒæ­¥ç­–ç•¥)
                await fetchAll(); 
            } catch (e) { alert("å­˜æª”å¤±æ•—"); btn.disabled = false; }
        }, 800);
    }

    function processAndRender() {
        const listDiv = document.getElementById('rankList');
        const modeMap = { max:"æœ€å¤§å–®æ¬¡", sum_max:"æœ€å¤§ç¸½å’Œ", min:"æœ€å°å–®æ¬¡", sum_min:"æœ€å°ç¸½å’Œ" };
        document.getElementById('modeTitle').innerText = `ğŸ† å…¨çƒæ’è¡Œ (${modeMap[currentMode]})`;

        const players = {};
        rawData.forEach(r => {
            const name = r[1], score = parseInt(r[2]);
            if(!name) return;
            if(!players[name]) players[name] = { name, history: [], sum: 0, max: 0, min: 99 };
            players[name].history.push(score);
            players[name].sum += score;
            players[name].max = Math.max(players[name].max, score);
            players[name].min = Math.min(players[name].min, score);
        });

        const sorted = Object.values(players).sort((a, b) => {
            if(currentMode === 'max') return b.max - a.max;
            if(currentMode === 'sum_max') return b.sum - a.sum;
            if(currentMode === 'min') return a.min - b.min;
            if(currentMode === 'sum_min') return a.sum - b.sum;
        });

        listDiv.innerHTML = sorted.map((p, i) => {
            const h = p.history;
            const isSum = currentMode.includes('sum');
            
            // è¨ˆç®— Highlight é‚è¼¯
            const checkHL = (val) => {
                if (isSum) return '';
                if (currentMode === 'max' && val === p.max) return 'hl';
                if (currentMode === 'min' && val === p.min) return 'hl';
                return '';
            };

            const sumHl = isSum ? 'hl' : '';

            return `
            <div class="rank-item">
                <div class="player-info">
                    <span>${i+1}. <b>${p.name}</b></span>
                    <span class="${sumHl}">${p.sum} é»</span>
                </div>
                <div class="score-details">
                    ( 1st: <span class="${checkHL(h[0])}">${h[0]||'-'}</span>, 
                      2nd: <span class="${checkHL(h[1])}">${h[1]||'-'}</span>, 
                      3rd: <span class="${checkHL(h[2])}">${h[2]||'-'}</span> )
                </div>
            </div>`;
        }).join('') || `<div style="padding:20px; color:#444;">å°šç„¡æ­·å²ç´€éŒ„</div>`;
    }

    async function resetData() {
        if(!confirm("Guliguliï¼Œç¢ºå®šæ¸…ç©ºå…¨çƒæ•¸æ“šï¼Ÿ")) return;
        await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'reset', admin: 'Guliguli' }) });
        location.reload();
    }

    // åˆå§‹è¼‰å…¥
    fetchAll();
    // å…¨çƒæ¯ 10 ç§’éœé»˜åŒæ­¥ä¸€æ¬¡åˆ¥äººçš„å‹•ä½œ
    setInterval(fetchAll, 10000);
</script>
</body>
</html>
